<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>适用于kubernetes的应用开发部署流程同时集成Istio service mesh - 小楼一夜听春雨</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="龙哥" /><meta name="description" content="本文讲解了如何开发容器化应用，并使用Wercker持续集成工具构建docker镜像上传到docker镜像仓库中，然后在本地使用docker-compose测试后，再使用kompose自动生成kubernetes的yaml文件，再将注入Envoy sidecar容器，集成Istio service mesh中的详细过程。" />

  <meta name="keywords" content="小楼一夜听春雨, devops, trader, cloud-native" />






<meta name="generator" content="Hugo 0.46" />


<link rel="canonical" href="https://b.qqbb.app/test/test/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.aaf3394fc81ccb6f6fe3fe458d1f5b61c39f151e44df83baaf1d7b3775a8b98d.css" integrity="sha256-qvM5T8gcy29v4/5FjR9bYcOfFR5E34O6rx17N3WouY0=" media="screen">





<meta property="og:title" content="适用于kubernetes的应用开发部署流程同时集成Istio service mesh" />
<meta property="og:description" content="本文讲解了如何开发容器化应用，并使用Wercker持续集成工具构建docker镜像上传到docker镜像仓库中，然后在本地使用docker-compose测试后，再使用kompose自动生成kubernetes的yaml文件，再将注入Envoy sidecar容器，集成Istio service mesh中的详细过程。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://b.qqbb.app/test/test/" />



<meta property="article:published_time" content="2018-03-26T22:48:44&#43;08:00"/>

<meta property="article:modified_time" content="2018-03-26T22:48:44&#43;08:00"/>











<meta itemprop="name" content="适用于kubernetes的应用开发部署流程同时集成Istio service mesh">
<meta itemprop="description" content="本文讲解了如何开发容器化应用，并使用Wercker持续集成工具构建docker镜像上传到docker镜像仓库中，然后在本地使用docker-compose测试后，再使用kompose自动生成kubernetes的yaml文件，再将注入Envoy sidecar容器，集成Istio service mesh中的详细过程。">


<meta itemprop="datePublished" content="2018-03-26T22:48:44&#43;08:00" />
<meta itemprop="dateModified" content="2018-03-26T22:48:44&#43;08:00" />
<meta itemprop="wordCount" content="5608">



<meta itemprop="keywords" content="kubernetes,cloud-native,istio,service-mesh,wercker," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="适用于kubernetes的应用开发部署流程同时集成Istio service mesh"/>
<meta name="twitter:description" content="本文讲解了如何开发容器化应用，并使用Wercker持续集成工具构建docker镜像上传到docker镜像仓库中，然后在本地使用docker-compose测试后，再使用kompose自动生成kubernetes的yaml文件，再将注入Envoy sidecar容器，集成Istio service mesh中的详细过程。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">小楼一夜听春雨</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/about/">关于</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/post/works/">作品</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      小楼一夜听春雨
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/about/">关于</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://b.qqbb.app/post/works/">作品</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
  
  <header class="post-header">
    <h1 class="post-title">适用于kubernetes的应用开发部署流程同时集成Istio service mesh</h1>
    
    <div class="post-meta">
      <time datetime="2018-03-26" class="post-time">
        2018-03-26
      </time>
    </div>
  </header>

  
  
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#环境声明">环境声明</a></li>
<li><a href="#应用示例">应用示例</a>
<ul>
<li><a href="#定义api">定义API</a></li>
<li><a href="#关于服务发现">关于服务发现</a></li>
</ul></li>
<li><a href="#持续集成">持续集成</a>
<ul>
<li>
<ul>
<li><a href="#wercker简介">Wercker简介</a></li>
<li><a href="#如何使用">如何使用</a></li>
<li><a href="#创建wercker配置文件wercker-yaml">创建Wercker配置文件Wercker.yaml</a></li>
</ul></li>
</ul></li>
<li><a href="#本地测试">本地测试</a></li>
<li><a href="#启动服务">启动服务</a></li>
<li><a href="#边缘节点配置">边缘节点配置</a></li>
<li><a href="#发布">发布</a></li>
<li><a href="#集成istio-service-mesh">集成Istio service mesh</a></li>
<li><a href="#验证">验证</a></li>
<li><a href="#参考">参考</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

  
  <div class="post-content">
      

<p>本文讲解了如何开发容器化应用，并使用Wercker持续集成工具构建docker镜像上传到docker镜像仓库中，然后在本地使用<code>docker-compose</code>测试后，再使用<code>kompose</code>自动生成kubernetes的yaml文件，再将注入Envoy sidecar容器，集成Istio service mesh中的详细过程。</p>

<p>当我们有了一个kubernetes集群后，如何在上面开发和部署应用，应该遵循怎样的流程？本次分享将向您展示如何使用go语言开发和部署一个kubernetes native应用，使用wercker进行持续集成与持续发布，我将以一个很简单的前后端访问，获取伪造数据并展示的例子来说明。</p>

<p><strong>注</strong>：本文部分内容曾是我2017年9月14日在DockOne社区分享的内容，本文同时归档到<a href="https://jimmysong.io/kubernetes-handbook">kubernetes-handbook</a>中。</p>

<p>整个过程如下图所示。</p>

<p><img src="https://jimmysong.io/kubernetes-handbook/images/how-to-use-kubernetes-with-istio.jpg" alt="流程图" /></p>

<p><strong>主要内容</strong></p>

<ul>
<li>服务API的定义</li>
<li>使用Go语言开发kubernetes原生应用</li>
<li>使用wercker做持续构建与发布</li>
<li>使用traefik和VIP做边缘节点提供外部访问路由</li>
<li>集成Istio Service Mesh</li>
</ul>

<h2 id="环境声明">环境声明</h2>

<p>首先声明下我们使用的集群环境：</p>

<ul>
<li>Docker1.12.5</li>
<li>flannel network host-gw</li>
<li>kubernetes 1.6.0+</li>
<li>TLS enabled</li>
</ul>

<p>详细的部署文档和更多资料请参考 <a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a></p>

<h2 id="应用示例">应用示例</h2>

<p>我们的这两个示例仅仅是为了演示，开发部署一个伪造的 metric 并显示在 web 页面上，包括两个service：</p>

<ul>
<li><a href="https://github.com/rootsongjc/k8s-app-monitor-test">k8s-app-monitor-test</a>：生成模拟的监控数据，发送http请求，获取json返回值</li>
<li><a href="https://github.com/rootsongjc/k8s-app-monitor-agent">K8s-app-monitor-agent</a>：获取监控数据并绘图，访问浏览器获取图表</li>
</ul>

<p>这两个镜像可以直接从docker hub上下载</p>

<ul>
<li>jimmysong/k8s-app-monitor-test:latest</li>
<li>jimmysong/k8s-app-monitor-agent:latest</li>
</ul>

<h3 id="定义api">定义API</h3>

<p><a href="https://github.com/rootsongjc/k8s-app-monitor-test">API文档</a> 中的<code>api.html</code>文件，该文档在API blueprint中定义，使用<a href="https://github.com/danielgtaylor/aglio">aglio</a> 生成，打开后如图所示：</p>

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/k8s-app-monitor-test-api-doc.jpg" alt="API文档" /></p>

<h3 id="关于服务发现">关于服务发现</h3>

<p><code>K8s-app-monitor-agent</code>服务需要访问<code>k8s-app-monitor-test</code>服务，这就涉及到服务发现的问题，我们在代码中直接写死了要访问的服务的内网DNS地址（kubedns中的地址，即<code>k8s-app-monitor-test.default.svc.cluster.local</code>）。</p>

<p>我们知道Kubernetes在启动Pod的时候为容器注入环境变量，这些环境变量在所有的 namespace 中共享（环境变量是不断追加的，新启动的Pod中将拥有老的Pod中所有的环境变量，而老的Pod中的环境变量不变）。但是既然使用这些环境变量就已经可以访问到对应的service，那么获取应用的地址信息，究竟是使用变量呢？还是直接使用DNS解析来发现？</p>

<p>答案是使用DNS，详细说明见<a href="http://jimmysong.io/posts/exploring-kubernetes-env-with-docker/">Kubernetes中的服务发现与Docker容器间的环境变量传递源码探究</a></p>

<h2 id="持续集成">持续集成</h2>

<p>开源项目的构建离不开CI工具，你可能经常会在很多GitHub的开源项目首页上看到这样的东西：</p>

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/wercker-budget.jpg" alt="wercker status badge" /></p>

<p>这些图标都是CI工具提供的，可以直观的看到当前的构建状态，例如wercker中可以在<code>Application</code>-<code>magpie</code>-<code>options</code>中看到：</p>

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/wercker-status-budge-setting.jpg" alt="wercker status badge设置" /></p>

<p>将文本框中的代码复制到你的项目的<code>README</code>文件中，就可以在项目主页上看到这样的标志了。</p>

<p>现在市面上有很多流行的CI/CD工具和DevOps工具有很多，这些工具提高了软件开发的效率，增加了开发人员的幸福感。这些工具有：</p>

<p>适用于GitHub上的开源项目，可以直接使用GitHub账户登陆，对于公开项目可以直接使用：<a href="https://travis-ci.org/">Travis-ci</a>、<a href="https://circleci.com/">CircleCI</a>、<a href="http://www.wercker.com/">Wercker</a>。从目前GitHub上开源项目的使用情况来看，Travis-ci的使用率更高一些。</p>

<p>适用于企业级的：<a href="https://jenkins.io/">Jenkins</a></p>

<p>不仅包括CI/CD功能的DevOps平台：<a href="https://www.jfrog.com/">JFrog</a>、<a href="https://spinnaker.io/">Spinnaker</a>、<a href="https://fabric8.io/">Fabric8</a></p>

<h4 id="wercker简介">Wercker简介</h4>

<p>Wercker是一家为现代云服务提供容器化应用及微服务的快速开发、部署工具的初创企业，成立于2012年，总部位于荷兰阿姆斯特丹。其以容器为中心的平台可以对微服务和应用的开发进行自动化。开发者通过利用其命令行工具能够生成容器到桌面，然后自动生成应用并部署到各种云平台上面。其支持的平台包括Heroku、AWS以及Rackspace等。</p>

<p>Wercker于2016年获得450万美元A轮融资，此轮融资由Inkef Capital领投，Notion Capital跟投，融资所得将用于商业版产品的开发。此轮融资过后其总融资额为750万美元。</p>

<p>Wercker于2017年4月被Oracle甲骨文于收购。</p>

<h4 id="如何使用">如何使用</h4>

<p>通过Wercker搭建CI环境只需经过三个基本步骤。</p>

<p>1．在Wercker网站中创建一个应用程序。</p>

<p>2．将wercker.yml添加到应用程序的代码库中。</p>

<p>3．选择打包和部署构建的位置。</p>

<p>可以使用GitHub帐号直接登录<a href="http://www.wercker.com/">Wercker</a>，整个创建应用CI的流程一共3步。</p>

<p>一旦拥有了账户，那么只需简单地点击位于顶部的<strong>应用程序</strong>菜单，然后选择<strong>创建</strong>选项即可。如果系统提示是否要创建组织或应用程序，请选择<strong>应用程序</strong>。Wercker组织允许多个Wercker用户之间进行协作，而无须提供信用卡。下图为设置新应用程序的向导页面。</p>

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/wercker-create-application.jpg" alt="向导页面" /></p>

<p>选择了GitHub中的repo之后，第二步配置访问权限，最后一步Wercker会尝试生成一个wercker.yml文件（后面会讨论）。不过至少对于Go应用程序来说，这个配置很少会满足要求，所以我们总是需要创建自己的Wercker配置文件。</p>

<h4 id="创建wercker配置文件wercker-yaml">创建Wercker配置文件Wercker.yaml</h4>

<p>Wercker配置文件是一个YAML文件，该文件必须在GitHub repo的最顶层目录，该文件主要包含三个部分，对应可用的三个主要管道。</p>

<p><strong>Dev</strong>：定义了开发管道的步骤列表。与所有管道一样，可以选定一个<strong>box</strong>用于构建，也可以全局指定一个box应用于所有管道。box可以是Wercker内置的预制Docker镜像之一，也可以是Docker Hub托管的任何Docker镜像。</p>

<p><strong>Build</strong>：定义了在Wercker构建期间要执行的步骤和脚本的列表。与许多其他服务（如Jenkins和TeamCity）不同，构建步骤位于代码库的配置文件中，而不是隐藏在服务配置里。</p>

<p><strong>Deploy</strong>：在这里可以定义构建的部署方式和位置。</p>

<p>Wercker中还有<strong>工作流</strong>的概念，通过使用分支、条件构建、多个部署目标和其他高级功能扩展了管道的功能，这些高级功能读着可以自己在wercker的网站中探索。</p>

<p>因为我使用wercker自动构建，构建完成后自动打包成docker镜像并上传到docker hub中（需要先在docker hub中创建repo），如何使用 wercker 做持续构建与发布，并集成docker hub插件请参考：<a href="https://jimmysong.io/posts/continuous-integration-with-wercker/">wercker构建</a></p>

<p>K8s-app-monitor-agent的wercker配置文件如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">box<span class="p">:</span><span class="w"> </span>golang<span class="w">
</span><span class="w">
</span><span class="w"></span>build<span class="p">:</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>steps<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>setup-go-workspace<span class="w">
</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>script<span class="p">:</span><span class="w">
</span><span class="w">        </span>name<span class="p">:</span><span class="w"> </span>go<span class="w"> </span>get<span class="w">
</span><span class="w">        </span>code<span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">          cd $WERCKER_SOURCE_DIR
</span><span class="sd">          go version
</span><span class="sd">          go get -u github.com/Masterminds/glide
</span><span class="sd">          export PATH=$WERCKER_SOURCE_DIR/bin:$PATH
</span><span class="sd">          glide install</span><span class="w">
</span><span class="w">    </span><span class="c"># Build the project</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>script<span class="p">:</span><span class="w">
</span><span class="w">        </span>name<span class="p">:</span><span class="w"> </span>go<span class="w"> </span>build<span class="w">
</span><span class="w">        </span>code<span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">          go build</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>script<span class="p">:</span><span class="w">
</span><span class="w">        </span>name<span class="p">:</span><span class="w"> </span>copy<span class="w"> </span>files<span class="w"> </span>to<span class="w"> </span>wercker<span class="w"> </span>output<span class="w"> 
</span><span class="w">        </span>code<span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">          cp -R ./ ${WERCKER_OUTPUT_DIR}</span><span class="w">
</span><span class="w"></span>deploy<span class="p">:</span><span class="w">
</span><span class="w"> </span>steps<span class="p">:</span><span class="w">
</span><span class="w">   </span>-<span class="w"> </span>internal/docker-push<span class="p">:</span><span class="w">
</span><span class="w">       </span>username<span class="p">:</span><span class="w"> </span>$USERNAME<span class="w">
</span><span class="w">       </span>password<span class="p">:</span><span class="w"> </span>$PASSWORD<span class="w">
</span><span class="w">       </span>cmd<span class="p">:</span><span class="w"> </span>/pipeline/source/k8s-app-monitor-agent<span class="w">
</span><span class="w">       </span>port<span class="p">:</span><span class="w"> </span><span class="s2">&#34;3000&#34;</span><span class="w">
</span><span class="w">       </span>tag<span class="p">:</span><span class="w"> </span>latest<span class="w">
</span><span class="w">       </span>repository<span class="p">:</span><span class="w"> </span>jimmysong/k8s-app-monitor-agent</code></pre></td></tr></table>
</div>
</div>
<p>其中的<code>$USERNAME</code>和<code>$PASSWORD</code>是docker hub的用户名和密码，这些是作为wercker构建时候的环境变量，在wercker的web端进行配置的。</p>

<p>此文件包含两个管道：build和deploy。在开发流程中，我们使用Wercker和Docker创建一个干净的Docker镜像，然后将它push到Docker Hub中。Wercker包含一个叫做<code>Internal/docker-push</code>的deploy plugin，可以将构建好的docker镜像push到镜像仓库中，默认是Docker Hub，也可以配置成私有镜像仓库。</p>

<p>box键的值是golang。这意味着我们使用的是一个基础的Docker镜像，它已经安装了Go环境。这一点至关重要，因为执行Wercker构建的基准Docker镜像需要包含应用程序所需的构建工具。</p>

<p><a href="https://app.wercker.com/jimmysong/k8s-app-monitor-agent">查看详细构建流程</a></p>

<blockquote>
<p>当然你还可以使用其他的CI工具，因为wercker的插件比较方便，可以直接构建成docker镜像上传到docker hub中，比较方便，所以我选择了wercker，作为个人项目和开源项目的话可以选择它，企业内部建议选择Jenkins。</p>
</blockquote>

<p>生成了如下两个docker镜像：</p>

<ul>
<li>jimmysong/k8s-app-monitor-test:latest</li>
<li>jimmysong/k8s-app-monitor-agent:latest</li>
</ul>

<h2 id="本地测试">本地测试</h2>

<p>在将服务发布到线上之前，我们可以先使用<code>docker-compose</code>在本地测试一下，这两个应用的<code>docker-compose.yaml</code>文件如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>k8s-app-monitor-agent<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>jimmysong/k8s-app-monitor-agent<span class="p">:</span>234d51c<span class="w">
</span><span class="w">    </span>container_name<span class="p">:</span><span class="w"> </span>monitor-agent<span class="w">
</span><span class="w">    </span>depends_on<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>k8s-app-monitor-test<span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="m">8888</span><span class="p">:</span><span class="m">8888</span><span class="w">
</span><span class="w">    </span>environment<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>SERVICE_NAME=k8s-app-monitor-test<span class="w">
</span><span class="w">  </span>k8s-app-monitor-test<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>jimmysong/k8s-app-monitor-test<span class="p">:</span>9c935dd<span class="w">
</span><span class="w">    </span>container_name<span class="p">:</span><span class="w"> </span>monitor-test<span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="m">3000</span><span class="p">:</span><span class="m">3000</span></code></pre></td></tr></table>
</div>
</div>
<p>执行下面的命令运行测试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up</code></pre></td></tr></table>
</div>
</div>
<p>在浏览器中访问<a href="http://localhost:8888/k8s-app-monitor-test">http://localhost:8888/k8s-app-monitor-test</a>就可以看到监控页面。</p>

<h2 id="启动服务">启动服务</h2>

<p>所有的kubernetes应用启动所用的yaml配置文件都保存在那两个GitHub仓库的<code>manifest.yaml</code>文件中。</p>

<p>比如<code>k8s-app-monitor-agent</code>的<code>manifest.yaml</code>文件如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>extensions/v1beta1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Deployment<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>k8s-app-monitor-agent<span class="w">
</span><span class="w">  </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">      </span>labels<span class="p">:</span><span class="w">
</span><span class="w">        </span>k8s-app<span class="p">:</span><span class="w"> </span>k8s-app-monitor-agent<span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>containers<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>image<span class="p">:</span><span class="w"> </span>jimmysong/k8s-app-monitor-agent<span class="p">:</span>latest<span class="w">
</span><span class="w">        </span>imagePullPolicy<span class="p">:</span><span class="w"> </span>Always<span class="w">
</span><span class="w">        </span>name<span class="p">:</span><span class="w"> </span>app<span class="w">
</span><span class="w">        </span>ports<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>containerPort<span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">        </span>env<span class="p">:</span><span class="w"> 
</span><span class="w">        </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>APP_PORT<span class="w">
</span><span class="w">          </span>value<span class="p">:</span><span class="w"> </span><span class="s2">&#34;3000&#34;</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>SERVICE_NAME<span class="w">
</span><span class="w">          </span>value<span class="p">:</span><span class="w"> </span><span class="s2">&#34;k8s-app-monitor-test&#34;</span><span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span>apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>k8s-app-monitor-agent<span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>k8s-svc<span class="p">:</span><span class="w"> </span>k8s-app-monitor-agent<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>ports<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>port<span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">    </span>protocol<span class="p">:</span><span class="w"> </span>TCP<span class="w">
</span><span class="w">    </span>name<span class="p">:</span><span class="w"> </span>http<span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>k8s-app<span class="p">:</span><span class="w"> </span>k8s-app-monitor-agent</code></pre></td></tr></table>
</div>
</div>
<p>注意其中的<code>env</code>，包括了两个环境变量（注意：环境变量名称必须为大写字母）：<code>APP_PORT</code>和<code>SERVICE_NAME</code>，这两个环境变量，在 <code>main.go</code>的代码中我们可以看到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">drawChart</span><span class="p">(</span><span class="nx">res</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">port</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&#34;APP_PORT&#34;</span><span class="p">)</span>
	<span class="nx">service</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&#34;SERVICE_NAME&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">port</span> <span class="p">=</span> <span class="s">&#34;3000&#34;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">service</span> <span class="p">=</span> <span class="s">&#34;localhost&#34;</span>
	<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>如果程序启动的时候找不到该环境变量，将会使用程序内置的默认值，当然我们不该将服务地址写死在程序内部，而应该是可配置的，在kubernetes中最佳配置方式是环境变量或者ConfigMap。</p>

<p>分别在两个GitHub目录下执行<code>kubectl create -f manifest.yaml</code>即可启动服务。</p>

<h2 id="边缘节点配置">边缘节点配置</h2>

<p>边缘节点架构图</p>

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/kubernetes-edge-node-architecture.png" alt="边缘节点架构图" /></p>

<p>选择Kubernetes的三个node作为边缘节点，并安装keepalived，上图展示了边缘节点的配置，同时展示了向Kubernetes中添加服务的过程。</p>

<p><strong>边缘节点定义</strong></p>

<p>首先解释下什么叫边缘节点（Edge Node），所谓的边缘节点即集群内部用来向集群外暴露服务能力的节点，集群外部的服务通过该节点来调用集群内部的服务，边缘节点是集群内外交流的一个Endpoint。</p>

<p><strong>边缘节点要考虑两个问题</strong></p>

<ul>
<li>边缘节点的高可用，不能有单点故障，否则整个kubernetes集群的外部访问将不可用</li>
<li>对外的一致暴露端口，即只能有一个外网访问IP和端口</li>
</ul>

<p>为了满足边缘节点的以上需求，我们使用<a href="http://www.keepalived.org/">keepalived</a>来实现。</p>

<p>在Kubernetes中添加了service的同时，在DNS中增加一个记录，这条记录需要跟ingress中的<code>host</code>字段相同，IP地址即VIP的地址，本示例中是<code>172.20.0.119</code>，这样集群外部就可以通过service的DNS名称来访问服务了。</p>

<p>参考<a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/practice/edge-node-configuration.md">详细操作步骤和配置</a></p>

<h2 id="发布">发布</h2>

<p>所有的kubernetes应用启动所用的yaml配置文件都保存在那两个GitHub仓库的<code>manifest.yaml</code>文件中。也可以使用<a href="https://github.com/kubernetes/kompose">kompose</a>这个工具，可以将*docker-compose*的YAML文件转换成kubernetes规格的YAML文件。</p>

<p>分别在两个GitHub目录下执行<code>kubectl create -f manifest.yaml</code>即可启动服务。也可以直接在*k8s-app-monitor-agent*代码库的<code>k8s</code>目录下执行<code>kubectl apply -f kompose</code>。</p>

<p>在以上YAML文件中有包含了Ingress配置，是为了将*k8s-app-monitor-agent*服务暴露给集群外部访问。</p>

<p><strong>方式一</strong></p>

<p>服务启动后需要更新ingress配置，在<a href="https://jimmysong.io/kubernetes-handbook/manifests/traefik-ingress/ingress.yaml">ingress.yaml</a>文件中增加以下几行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span>-<span class="w"> </span>host<span class="p">:</span><span class="w"> </span>k8s-app-monitor-agent.jimmysong.io<span class="w">
</span><span class="w">    </span>http<span class="p">:</span><span class="w">
</span><span class="w">      </span>paths<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>path<span class="p">:</span><span class="w"> </span>/k8s-app-monitor-agent<span class="w">
</span><span class="w">        </span>backend<span class="p">:</span><span class="w">
</span><span class="w">          </span>serviceName<span class="p">:</span><span class="w"> </span>k8s-app-monitor-agent<span class="w">
</span><span class="w">          </span>servicePort<span class="p">:</span><span class="w"> </span><span class="m">8888</span></code></pre></td></tr></table>
</div>
</div>
<p>保存后，然后执行<code>kubectl replace -f ingress.yaml</code>即可刷新ingress。</p>

<p>修改本机的<code>/etc/hosts</code>文件，在其中加入以下一行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ini" data-lang="ini"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ini" data-lang="ini"><span class="na">172.20.0.119 k8s-app-monitor-agent.jimmysong.io</span></code></pre></td></tr></table>
</div>
</div>
<p>当然你也可以将该域名加入到内网的DNS中，为了简单起见我使用hosts。</p>

<p><strong>方式二</strong></p>

<p>或者不修改已有的Ingress，而是为该队外暴露的服务单独创建一个Ingress，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>extensions/v1beta1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Ingress<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>k8s-app-monitor-agent-ingress<span class="w">
</span><span class="w">  </span>annotations<span class="p">:</span><span class="w">
</span><span class="w">    </span>kubernetes.io/ingress.class<span class="p">:</span><span class="w"> </span><span class="s2">&#34;treafik&#34;</span><span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>rules<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>host<span class="p">:</span><span class="w"> </span>k8s-app-monitor-agent.jimmysong.io<span class="w">
</span><span class="w">    </span>http<span class="p">:</span><span class="w">
</span><span class="w">      </span>paths<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>path<span class="p">:</span><span class="w"> </span>/<span class="w">
</span><span class="w">        </span>backend<span class="p">:</span><span class="w">
</span><span class="w">          </span>serviceName<span class="p">:</span><span class="w"> </span>k8s-app-monitor-agent<span class="w">
</span><span class="w">          </span>servicePort<span class="p">:</span><span class="w"> </span><span class="m">8888</span></code></pre></td></tr></table>
</div>
</div>
<p>详见<a href="https://jimmysong.io/kubernetes-handbook/practice/edge-node-configuration.html">边缘节点配置</a>。</p>

<h2 id="集成istio-service-mesh">集成Istio service mesh</h2>

<p>上一步中我们生成了kubernetes可读取的应用的YAML配置文件，我们可以将所有的YAML配置和并到同一个YAML文件中假如文件名为<code>k8s-app-monitor-istio-all-in-one.yaml</code>，如果要将其集成到Istio service mesh，只需要执行下面的命令。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kubectl apply -n default -f &lt;<span class="o">(</span>istioctl kube-inject -f k8s-app-monitor-istio-all-in-one.yaml<span class="o">)</span></code></pre></td></tr></table>
</div>
</div>
<p>这样就会在每个Pod中注入一个sidecar容器。</p>

<h2 id="验证">验证</h2>

<p>如果您使用的是Traefik ingress来暴露的服务，那么在浏览器中访问<a href="http://k8s-app-monitor-agent.jimmysong.io/k8s-app-monitor-agent">http://k8s-app-monitor-agent.jimmysong.io/k8s-app-monitor-agent</a>，可以看到如下的画面，每次刷新页面将看到新的柱状图。</p>

<p><img src="https://jimmysong.io/kubernetes-handbook/images/k8s-app-monitor-agent.jpg" alt="图表" /></p>

<p>使用<a href="https://github.com/rootsongjc/kubernetes-vagrant-centos-cluster">kubernetes-vagrant-centos-cluster</a>来部署的kubernetes集群，该应用集成了Istio service mesh后可以通过<a href="http://172.17.8.101:32000/k8s-app-monitor-agent">http://172.17.8.101:32000/k8s-app-monitor-agent</a>来访问。</p>

<p>在对<code>k8s-app-monitor-agent</code>服务进行了N此访问之后，再访问<a href="http://grafana.istio.jimmysong.io/">http://grafana.istio.jimmysong.io</a>可以看到Service Mesh的监控信息。</p>

<p><img src="https://jimmysong.io/kubernetes-handbook/images/k8s-app-monitor-istio-grafana.png" alt="Grafana页面" /></p>

<p>访问<a href="http://servicegraph.istio.jimmysong.io/dotviz">http://servicegraph.istio.jimmysong.io/dotviz</a>可以看到服务的依赖和QPS信息。</p>

<p><img src="https://jimmysong.io/kubernetes-handbook/images/k8s-app-monitor-istio-servicegraph-dotviz.png" alt="servicegraph页面" /></p>

<p>访问<a href="http://zipkin.istio.jimmysong.io/">http://zipkin.istio.jimmysong.io</a>可以选择查看<code>k8s-app-monitor-agent</code>应用的追踪信息。</p>

<p><img src="https://jimmysong.io/kubernetes-handbook/images/k8s-app-monitor-istio-zipkin.png" alt="Zipkin页面" /></p>

<p>至此从代码提交到上线到Kubernetes集群上并集成Istio service mesh的过程就全部完成了。</p>

<blockquote>
<p>本文首发于2017年9月14日，更新于2018年3月26日。</p>
</blockquote>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://jimmysong.io/posts/deploy-applications-in-kubernetes/">适用于Kubernetes的应用开发与部署流程详解</a></li>
<li><a href="https://app.wercker.com/jimmysong/k8s-app-monitor-agent/">示例的项目代码服务器端</a></li>
<li><a href="https://github.com/rootsongjc/k8s-app-monitor-agent">示例项目代码前端</a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/">kubernetes-handbok</a></li>
<li><a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/practice/edge-node-configuration.md">边缘节点配置</a></li>
</ul>

  </div>

  
  
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">龙哥</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2018-03-26</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


  
  
</article>




  
  

  

  

  
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
  
    <a href="mailto:273412935@qq.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>


<a href="https://b.qqbb.app/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  
  
  
  
  
  
  

  <span class="copyright-year">
    &copy;
    
      2017 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        圆月弯刀
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ="></script>
<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?9dd8f468d36a07a7a8bde80b13fe8eaf";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>





  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>










</body>
</html>
